Title:	jelparse: crash with lang=xxx tag
Stat:   closed
Disp:	done
Prio:	high
Cats:	dev
Reqtrs:	
AssdTo:	stuart

2010-05-29 10:58:00 stuart 
  The following input:

    Reading: <whatever>
    Senses: [1][lang=ger] glosstext

  on the edform.py page causes a crash:

  Traceback (most recent call last):
  File "c:\stuart\develop\jdb\jb\web\cgi\edconf.py", line 284, in <module>
    main (args, opts)
  File "c:\stuart\develop\jdb\jb\web\cgi\edconf.py", line 93, in main
    entr, perrs = parse (intxt)
  File "c:\stuart\develop\jdb\jb\web\cgi\edconf.py", line 275, in parse
    entr = parser.parse (krstext, lexer=lexer, tracking=True)
  File "C:\Program Files\Python\lib\site-packages\ply\yacc.py", line 263, in parse
    return self.parseopt(input,lexer,debug,tracking,tokenfunc)
  File "C:\Program Files\Python\lib\site-packages\ply\yacc.py", line 710, in parseopt
    p.callable(pslice)
  File "../../python/lib\jelparse.py", line 144, in p_sense_1
    err = bld_sens (sens, p[2])
  File "../../python/lib\jelparse.py", line 511, in bld_sens
    if tags: errs.extend (sens_tags (sens, gloss, tags))
  File "../../python/lib\jelparse.py", line 607, in sens_tags
    assert isinstance(t,int)
  AssertionError

2010-05-29 17:26:00 stuart
  Problem was in python/lib/jelpparse.y, in function sens_tags().
  Added the indicated line:

            elif typ == 'LANG':
  +             t = t[0]        # LANG tags have only one value, the lang code.
                assert isinstance(t,int)
        	if getattr (gloss, 'lang', None):
                    errs.append (
                        "Warning, duplicate LANG tag '%s' ignored\n" % KW.LANG[t].kw)
        		else: gloss.lang = t

  Added tests jelparse.0100070 and 0100080 to verify fix.

  Also made fix to python/lib/fmtjel.py that caused surious blank line
  to be added before a gloss with a [lang=xxx] tag when it was the 
  first gloss.
