Title:	Error when xref given by seq number
Stat:	closed
Disp:	done
Prio:	high
Cats:	dev
Reqtrs:	
AssdTo:	stuart

2010-06-14 11:36:00 stuart
  Email from Jim Breen reports that using the syntax 
   [see=2029100]
  for an xref in the edit form results in a crash in in edconf.py
  when the target entry has no kanji.

2010-06-14 11:42:00 stuart
  Email from jwb:
  > I'm rolling in yesterday's updates. One was an amendment
  > to 2457930 (わね). In the amendment, Paul added xrefs to
  > わ and ね.  The conform screen showed multiple targets
  > for these, so I went back to the edit and changed them to:
  >
  > [see=2029100]
  > [see=2029080]
  >
  > which follows the format given on
  > http://edrdg.org/jmdictdb/cgi-bin/edhelp.py#syn_xref
  >
  > No go. I get an error report:
  > Traceback (most recent call last):
  >   File "/usr/local/apache2/jmdictdb/cgi-bin/edconf.py", line 301, in <module> 
  >     main (args, opts)
  >   File "/usr/local/apache2/jmdictdb/cgi-bin/edconf.py", line 171, in main
  >     entr.stat==KW.STAT['D'].id)
  >   File "../lib/jdb.py", line 1298, in add_hist
  >     if pentr is not e \
  >   File "../lib/fmtxml.py", line 568, in entr_diff
  >     else: enewxml = entr (enew, wantlist=1, implicit_pos=0)
  >   File "../lib/fmtxml.py", line 90, in entr
  >     fmt.extend (sens (x, kanjs, rdngs, compat, entr.src, genxrefs, last_pos))
  >   File "../lib/fmtxml.py", line 190, in sens
  >     xr.extend (xrefs (xrfs, (not compat) and src))
  >   File "../lib/fmtxml.py", line 316, in xrefs
  >     fmtdxref = xref (x, src)
  >   File "../lib/fmtxml.py", line 361, in xref
  >     r = targobj._rdng[xref.rdng-1].txt
  > TypeError: unsupported operand type(s) for -: 'Rdng' and 'int'
  >
  > This seems to be related to the xref target being kana-only.
  > If I replace them with, e.g. [see=1290020] it's fine.

2010-06-14 12:19:00 stuart
  In current rev (a0c29fb5dc2d 2010-06-11), the traceback above is not
  seen but rather the normal edconf.py page is displayed with a cross
  ref that has the exception message embedded in page output:

    see: 1036080  Exception: unsupported operand type(s) for -: 'Rdng' and 'int' 1.on-line 

  Either way, problem was in jdb.headword() which sometimes returned 
  reading or kanji index numbers (as documented) but sometimes 
  (incorrectly) returned Rdng objects.
