Title:	Unable to submit lsrc without text
Stat:   closed
Disp:	done
Prio:	high
Cats:	dev
Reqtrs:	
AssdTo:	stuart

2010-06-15 07:21:00 stuart
  Email from Jim Breen reports that using the syntax 
   [lsrc=fre:]
  is accepted by edconf.py page, but fails on submission
  with a traceback.

2010-06-15 07:24:00 stuart
  Email from jwb:
  > Odd one today. Trying to add (re-instate)
  > an lsrc tag to  1142040. It was there originally,
  > but in an edit got turned into (fre:). I put
  > "[lsrc=fre:]" and it passed edconf.py OK,
  > but on Submit/confirm I got:
  > 
  > Traceback (most recent call last):
  >   File "/home/smg/public_html/cgi-bin/edsubmit.py", line 418, in <module>
  >     main (args, opts)
  >   File "/home/smg/public_html/cgi-bin/edsubmit.py", line 158, in main
  >     sess.userid if sess else None)
  >   File "/home/smg/public_html/cgi-bin/edsubmit.py", line 291, in submission
  >     added = approve (dbh, entr, errs)
  >   File "/home/smg/public_html/cgi-bin/edsubmit.py", line 360, in approve
  >     res = addentr (dbh, entr)
  >   File "/home/smg/public_html/cgi-bin/edsubmit.py", line 398, in addentr
  >     res = jdb.addentr (dbh, entr)
  >   File "../lib/jdb.py", line 1390, in addentr
  >     for x in getattr (s, '_lsrc',  []): dbinsert (cur, "lsrc",
  > ['entr','sens','ord','lang','txt','part','wasei'], x)
  >   File "../lib/jdb.py", line 120, in dbinsert
  >     raise e
  > IntegrityError: null value in column "txt" violates not-null constraint

 
2010-06-15 15:00:00 stuart
  Problem is that the jelparse.y parser section that handles
  the [lsrc=xxx:] cobstruct was 
    | TEXT EQL TEXT COLON	/* lsrc=xx: ('xx' is language code.) */
      { KW = jdb.KW 
        if p[1] != "lsrc": perror (p, "Keyword must be \"lsrc\"")
      	  la = KW.LANG.get(p[3])
	  if not la: perror (p, "Unrecognised language '%s'" % p[3])
	  p[0] = ["lsrc", None, la.id, None] }

  The first None in the last line is the problem -- it is the 
  lsrc text field and should be "" for no text since the lsrc
  table in the database has a NOT NULL constraint on the text
  ('txt') column. 

  However, I actually fixed the problem in jelparse.y, 
  sens_tags() in the "lsrc" section where 

    jdb.Lsrc(txt=t[0]

  was changed to 

    jdb.Lsrc(txt=t[0] or ''

  just in case thee are any other paths that lead here with
  None as the text value.
