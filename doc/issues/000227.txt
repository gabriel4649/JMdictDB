Title:	'diff' field in entry hist not blank though no change made.
Stat:	open
Disp:	closed
Prio:	med
Cats:	bug
Reqtrs:	
AssdTo:	stuart

2013-12-22 9:57:00 stuart
 When evaluating the Python3 code prior to deployment at edrdg.org,
 jwb noticed that when a new entry is submitted with no changes made
 to it, the diff in the history record shows "@@ -1 +1 @@" (should
 be NULL in database resulting in no "diff" field in the web page 
 history section.).

2013-12-22 10:43:00 stuart
 Am able to reproduce locally.
 1. Using the usual web interface edit a random entry and submit it
    with no changes.  Note the id numbers of the originally and newly
    submitted entries.  In my case they were 34234 and 1062644
    respectively.
 2. Interactively run the following code under python3 in a python3
    ("default") branch, and under python2 in a python2 ("py2maint)
    branch (cd to python/lib):
      import jdb, fmtxml
      c=jdb.dbOpen('jmdict')
      entr1=jdb.entrList(c,None,[34234])[0]
      entr2=jdb.entrList(c,None,[1062644])[0]
      fmtxml.entr_diff (entr1,entr2)

 In the python2 case, fmtxml.entr_diff() prints ''.  In the python3
 case, fmtxml.entr_diff() prints '@@ -1 +1 @@'.

2013-12-22 11:18:00 stuart
 Running "fmtxml.entr_diff (entr1,entr2,n=0)" interactively under the 
 python's pdb debugger, and stepping through the code allows us 
 to look at the string, 'rawdiff', returned by pythons difflib.-
 unified_diff() function inside entr_diff():

 py2:
  ['--- \n', '+++ \n', '@@ -1,1 +1,1 @@\n', u'-<entry id="34234" stat="A">', u'+<entry id="1062644" stat="A" appr="n" dfrm="34234">']

 py3:
  ['--- \n', '+++ \n', '@@ -1 +1 @@\n', '-<entry id="34234" stat="A">', '+<entry id="1062644" stat="A" appr="n" dfrm="34234">']

 Further down in entr_diff() there is code to remove the "@@ ... @@" 
 lines:

   if not ([...] or x.startswith ('@@ -1,1 +1,1 @@'))

 Changed that line to:

   if not ([...] or x.startswith ('@@ -1 +1 @@'))

 to match what Python3's diff function now seem to return.
 Testing now shows that a no-change edit made via the web page 
 correctly results in a history entry without any diff text.

2013-12-22 13:53:00 stuart
 Added test class "Test_entr_diff" to python/tests/test_fmtxml.py
 and the data for those tests to python/tests/data/fmtxml_data.py
 (Test cases 0400010 and 0400020).  Both failed with the previous
 version of python/lib/fmtxml.py, both pass with the fixed version.


